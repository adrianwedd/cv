name: 📊 Simple Data Refresh Pipeline

# Simple, reliable data refresh pipeline with manual trigger support
# Focused on Watch Me Work dashboard updates and basic data refresh

on:
  workflow_dispatch:
    inputs:
      refresh_type:
        description: 'Data to refresh'
        required: false
        default: 'dashboard'
        type: choice
        options:
          - dashboard    # Watch Me Work data only
          - activity     # GitHub activity analysis
          - all          # Both dashboard and activity

env:
  NODE_VERSION: '20'
  TIMEZONE: 'Australia/Tasmania'

jobs:
  simple-data-refresh:
    name: 🔄 Simple Data Refresh
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    permissions:
      contents: write
    
    steps:
      - name: 📂 Repository Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ⚡ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '.github/scripts/package-lock.json'

      - name: 📦 Install Dependencies
        run: |
          cd .github/scripts
          npm ci --prefer-offline --no-audit

      - name: 🎬 Refresh Watch Me Work Data
        if: ${{ github.event.inputs.refresh_type == 'dashboard' || github.event.inputs.refresh_type == 'all' }}
        run: |
          cd .github/scripts
          echo "🎬 Refreshing Watch Me Work dashboard data..."
          
          timeout 240 node watch-me-work-data-processor.js
          
          if [ $? -eq 0 ]; then
            echo "✅ Watch Me Work data refreshed successfully"
            
            if [ -f "../../data/watch-me-work-data.json" ]; then
              ACTIVITIES=$(jq '.activities | length' ../../data/watch-me-work-data.json)
              REPOS=$(jq '.repositories | length' ../../data/watch-me-work-data.json)
              echo "📊 Generated: $ACTIVITIES activities, $REPOS repositories"
            fi
          else
            echo "⚠️ Watch Me Work refresh failed"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 📊 Refresh Activity Data
        if: ${{ github.event.inputs.refresh_type == 'activity' || github.event.inputs.refresh_type == 'all' }}
        run: |
          cd .github/scripts
          echo "📊 Refreshing GitHub activity data..."
          
          timeout 300 node activity-analyzer.js
          
          if [ $? -eq 0 ]; then
            echo "✅ Activity data refreshed successfully"
          else
            echo "⚠️ Activity refresh failed"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 💾 Commit Changes
        run: |
          echo "💾 Committing data changes..."
          
          git config --local user.email "simple-refresh@adrianwedd.com"
          git config --local user.name "adrianwedd(simple-refresh)"
          
          git add data/ .github/scripts/data/ || true
          
          if ! git diff --cached --quiet; then
            TIMESTAMP=$(TZ='${{ env.TIMEZONE }}' date +'%Y%m%d-%H%M')
            
            git commit -m "📊 Simple data refresh (${{ github.event.inputs.refresh_type }}) - $TIMESTAMP"
            
            git push
            echo "✅ Changes committed and pushed"
          else
            echo "📝 No changes to commit"
          fi