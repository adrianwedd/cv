name: Automated Dependency Updates

on:
  schedule:
    - cron: '0 6 * * 1' # Weekly on Monday at 6 AM
  workflow_dispatch:

jobs:
  # DISABLED FOR BILLING - REMOVE WHEN BILLING RESOLVED
  disabled:
    if: true
    runs-on: ubuntu-latest
    steps:
      - run: echo "All workflows disabled for billing management"
  # TEMPORARILY DISABLED FOR BILLING - DO NOT RUN
  disabled-for-billing:
    if: false
    runs-on: ubuntu-latest
    steps:
      - run: echo "Workflow disabled for billing management"  dependency-updates:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Run dependency manager
        run: |
          cd .github/scripts
          npm install
          node dependency-manager.js
          
      - name: Update dependencies (minor/patch only)
        run: |
          # Update dependencies in each package.json location
          locations=("." ".github/scripts" "tests" "monitoring")
          for location in "${locations[@]}"; do
            if [ -f "$location/package.json" ]; then
              cd "$location"
              echo "Updating dependencies in $location"
              npm update
              cd - > /dev/null
            fi
          done
          
      - name: Run security audit fix
        run: |
          locations=("." ".github/scripts" "tests" "monitoring")
          for location in "${locations[@]}"; do
            if [ -f "$location/package.json" ]; then
              cd "$location"
              echo "Running security audit fix in $location"
              npm audit fix --only=prod || true
              cd - > /dev/null
            fi
          done
          
      - name: Run tests
        run: |
          if [ -f "package.json" ] && npm run test --if-present; then
            echo "Tests passed"
          fi
          
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ðŸ“¦ Automated dependency updates'
          title: 'ðŸ“¦ Weekly Dependency Updates'
          body: |
            ## Automated Dependency Updates
            
            This PR contains automated dependency updates:
            
            - âœ… Security vulnerabilities patched
            - âœ… Minor and patch updates applied  
            - âœ… Tests passed
            
            ### Summary
            - Updated packages with security fixes
            - Applied safe minor/patch updates
            - No breaking changes expected
            
            Generated by automated dependency management system.
          branch: automated-dependency-updates
          delete-branch: true
          
      - name: Auto-merge if tests pass
        uses: pascalgn/merge-action@v0.15.6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          merge_method: merge
        env:
          MERGE_LABELS: dependencies,automated
          MERGE_DELETE_BRANCH: true
