name: ðŸš€ Staging Environment Deployment

# Staging deployment for develop branch
# Provides safe testing environment before production

on:
  push:
    branches: [ develop ]
  schedule:
    # Run every 2 hours for continuous testing
    # Reduced frequency - only once daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_full_rebuild:
        description: 'ðŸ”„ Force complete rebuild'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  STAGING_BRANCH: 'gh-pages-staging'

jobs:
  # DISABLED FOR BILLING - REMOVE WHEN BILLING RESOLVED
  disabled:
    if: true
    runs-on: ubuntu-latest
    steps:
      - run: echo "All workflows disabled for billing management"
  
  staging-quality-gates:
    if: false  # DISABLED
    name: ðŸ›¡ï¸ Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    outputs:
      quality-passed: ${{ steps.quality-check.outputs.passed }}
      
    steps:
      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '.github/scripts/package-lock.json'
          
      - name: ðŸ“¦ Install Dependencies
        run: |
          cd .github/scripts
          npm ci --silent
          
      - name: ðŸ§ª Run Quality Checks
        id: quality-check
        run: |
          cd .github/scripts
          
          echo "ðŸ§ª **STAGING QUALITY GATES**"
          echo "============================"
          
          # Lint check
          echo "ðŸ“ Running ESLint..."
          if npm run lint; then
            echo "âœ… Lint: PASSED"
            LINT_PASSED=true
          else
            echo "âŒ Lint: FAILED"
            LINT_PASSED=false
          fi
          
          # Data validation
          echo "ðŸ“Š Validating data files..."
          DATA_VALID=true
          for file in ../../data/*.json; do
            if [ -f "$file" ]; then
              if jq empty "$file" 2>/dev/null; then
                echo "âœ… $(basename "$file"): Valid JSON"
              else
                echo "âŒ $(basename "$file"): Invalid JSON"
                DATA_VALID=false
              fi
            fi
          done
          
          # Overall quality gate
          if [ "$LINT_PASSED" = true ] && [ "$DATA_VALID" = true ]; then
            echo "quality_passed=true" >> $GITHUB_OUTPUT
            echo "âœ… **Quality Gates: PASSED**"
          else
            echo "quality_passed=false" >> $GITHUB_OUTPUT
            echo "âŒ **Quality Gates: FAILED**"
            exit 1
          fi

  staging-build:
    name: ðŸ—ï¸ Build Staging Site
    runs-on: ubuntu-latest
    needs: staging-quality-gates
    if: needs.staging-quality-gates.outputs.quality-passed == 'true'
    timeout-minutes: 30
    
    steps:
      - name: ðŸ“‚ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ”§ Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '.github/scripts/package-lock.json'
          
      - name: ðŸ“¦ Install Dependencies
        run: |
          cd .github/scripts
          npm ci --silent
          
      - name: ðŸ¤– GitHub Activity Analysis
        run: |
          cd .github/scripts
          echo "ðŸ“Š **STAGING: GITHUB ACTIVITY ANALYSIS**"
          
          if node activity-analyzer.js; then
            echo "âœ… Activity analysis completed"
          else
            echo "âš ï¸ Activity analysis failed, using cached data"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ§  AI Content Enhancement
        run: |
          cd .github/scripts
          echo "ðŸ§  **STAGING: AI CONTENT ENHANCEMENT**"
          
          # Try browser authentication first, then API fallback
          if node claude-enhancer.js; then
            echo "âœ… AI enhancement completed"
          else
            echo "âš ï¸ AI enhancement failed, using existing content"
          fi
        env:
          CLAUDE_SESSION_KEY: ${{ secrets.CLAUDE_SESSION_KEY }}
          CLAUDE_ORG_ID: ${{ secrets.CLAUDE_ORG_ID }}
          CLAUDE_USER_ID: ${{ secrets.CLAUDE_USER_ID }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AUTH_STRATEGY: browser_first
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ðŸ›¡ï¸ AI Hallucination Detection
        continue-on-error: true
        run: |
          cd .github/scripts
          echo "ðŸ›¡ï¸ **STAGING: AI HALLUCINATION DETECTION**"
          
          if npm run hallucination:detect; then
            echo "âœ… Hallucination detection: PASSED"
          else
            echo "âš ï¸ Hallucination detection: WARNING - Content flagged for review"
          fi
          
      - name: ðŸŽ¨ Generate Staging Website
        run: |
          cd .github/scripts
          echo "ðŸŽ¨ **STAGING: WEBSITE GENERATION**"
          
          # Set staging-specific environment
          export SITE_URL="https://adrianwedd.github.io/cv-staging"
          export STAGING_ENV=true
          
          if node cv-generator.js; then
            echo "âœ… Staging website generated"
          else
            echo "âŒ Website generation failed"
            exit 1
          fi
          
      - name: ðŸ“‹ Multi-Format Validation
        run: |
          cd .github/scripts
          echo "ðŸ“‹ **STAGING: MULTI-FORMAT VALIDATION**"
          
          if npm run formats:validate; then
            echo "âœ… Multi-format validation: PASSED"
          else
            echo "âš ï¸ Multi-format validation: WARNING"
          fi
          
      - name: ðŸš€ Deploy to Staging
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: gh-pages-staging
          force_orphan: true
          commit_message: |
            ðŸš€ Staging deployment from develop branch
            
            Generated from commit: ${{ github.sha }}
            Triggered by: ${{ github.event_name }}
            
            ðŸ”— Staging URL: https://adrianwedd.github.io/cv-staging
            
            ðŸ¤– Generated with [Claude Code](https://claude.ai/code)
            
      - name: ðŸ“Š Generate Staging Report
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Staging Deployment Report
          
          **Branch**: develop  
          **Commit**: ${{ github.sha }}  
          **Status**: ${{ job.status }}  
          **Environment**: https://adrianwedd.github.io/cv-staging
          
          ### âœ… Quality Gates Passed
          - ESLint validation
          - JSON data validation  
          - Multi-format generation
          - AI hallucination detection
          
          ### ðŸ”— Staging Environment
          - **URL**: https://adrianwedd.github.io/cv-staging
          - **Branch**: gh-pages-staging
          - **Auto-deploy**: Every 2 hours from develop
          - **Manual Deploy**: Workflow dispatch available
          
          ### ðŸŽ¯ Next Steps
          - Review staging environment
          - Test all functionality  
          - When ready, create PR from develop â†’ main
          - Production deployment will trigger automatically
          EOF

  staging-notification:
    name: ðŸ“¢ Staging Notification
    runs-on: ubuntu-latest
    needs: [staging-quality-gates, staging-build]
    if: always()
    
    steps:
      - name: ðŸ“¢ Success Notification
        if: needs.staging-build.result == 'success'
        run: |
          echo "âœ… **STAGING DEPLOYMENT SUCCESSFUL**"
          echo "ðŸ”— Staging environment updated: https://adrianwedd.github.io/cv-staging"
          echo "ðŸ“ All quality gates passed"
          echo "ðŸš€ Ready for production review"
          
      - name: ðŸ“¢ Failure Notification  
        if: needs.staging-build.result == 'failure' || needs.staging-quality-gates.result == 'failure'
        run: |
          echo "âŒ **STAGING DEPLOYMENT FAILED**"
          echo "ðŸ” Check workflow logs for details"
          echo "ðŸ› ï¸ Fix issues in develop branch"
          echo "ðŸ”„ Push changes to trigger new staging build"